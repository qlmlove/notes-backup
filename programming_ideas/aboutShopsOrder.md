---
title: 关于商品订单的思考
tags: []
date: 2018-04-09 12:05:08
---
关于下单的一些想法
<!--more-->

## 一种办法

- 用户选择商品后,向api提交所选商品相关的信息,如:商品id
- API在收到信息后,检测对应商品的库存量
- 有库存,把订单数据存入数据库,并且告诉客户端'下单成功',等待支付
- 调用支付接口进行支付
- 再次进行库存量检测
- 微信服务器返回支付结果(此操作异步进行)
- 如果成功: 进行库存量检测,如果足够,则扣除库存量,(否则进行退款操作)

注:
> 不一定会完全按照上述顺序执行或者说一定不会完全按照上述顺序执行,因为:
- 异步首先就不会完全按顺序执行
- 用户也可能在任何一步取消订单

---
[ ] 流程图待完成

## 另一种想法

- 用户选择商品后,向api提交所选商品相关的信息,如:商品id
- API在收到信息后,检测对应商品的库存量

  - 有库存: 把订单数据存入数据库,**同时扣除库存**,并且告诉客户端'下单成功',等待支付,**同时设置有效时间**

    - 未超时:调用支付接口进行支付,微信服务器返回支付结果(此操作异步进行)

      - 如果成功: 通知客户端
      - 如果失败: 通知客户端

    - 已超时: 撤销商品扣除操作(增加扣除的量),并通知客户单超时,请重新下单

  - 库存不足: 通过客户端告知用户

---
[ ] 流程图待完成